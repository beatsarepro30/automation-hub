RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ROCKET="ðŸš€"
CHECKMARK="âœ…"
CROSSMARK="âŒ"
CANCEL="âš ï¸"

TF_LOG_ROOT="$HOME/.terraform_logs"
mkdir -p "$TF_LOG_ROOT"

_get_workspace_name() {
  local ws
  ws=$(terraform workspace show 2>/dev/null || true)
  [[ -z "$ws" || "$ws" == "default" ]] && ws=$(pwd | sed 's|/|_|g; s|^_||')
  echo "$ws"
}

_get_master_log() {
  local ws=$(_get_workspace_name)
  echo "$TF_LOG_ROOT/${ws}.logs"
}

_make_run_log_path() {
  local type=$1
  local ws
  local timestamp
  ws=$(_get_workspace_name)
  timestamp=$(date +"%Y-%m-%d_%H%M%S")
  local dir="$TF_LOG_ROOT/$ws"
  mkdir -p "$dir" || return 1
  echo "${dir}/${type}-${timestamp}.log"
}

_strip_ansi() {
  sed -r "s/\x1B\[[0-9;]*[mK]//g"
}

_strip_ansi_str() {
  echo -e "$1" | _strip_ansi
}

_append_master_log() {
  local type=$1
  local status=$2
  local log_file=$3
  local master_log
  master_log=$(_get_master_log) || return 1

  [[ "$type" != "plan" && "$type" != "apply" && "$type" != "destroy" ]] && return 0

  local timestamp
  timestamp=$(date +"%Y-%m-%d %H:%M:%S")

  local urls target
  urls=$(grep -Eo 'https?://[^ ]+' "$log_file" | sed -r "s/\x1B\[[0-9;]*[mK]//g" 2>/dev/null || true)
  target=$(echo "$urls" | grep -i '\.com/app' || echo "local")
  target=$(_strip_ansi_str "$target")

  local emoji color
  case "$status" in
    SUCCESS)
      emoji="$CHECKMARK"
      color="$GREEN"
      ;;
    FAILED)
      emoji="$CROSSMARK"
      color="$RED"
      ;;
    CANCELLED)
      emoji="$CANCEL"
      color="$YELLOW"
      ;;
    *)
      emoji="â“"
      color="$NC"
      ;;
  esac

  local padded_type
  printf -v padded_type "%-7s" "$type"

  local entry="${emoji} ${padded_type} (${timestamp}) ${target} | ${log_file}"

  { echo -e "$entry"; cat "$master_log" 2>/dev/null || true; } > "${master_log}.tmp" \
    && mv -f "${master_log}.tmp" "$master_log"

  echo -e "\n${color}${emoji} Terraform ${type} ${status,,}!${NC}"
  echo -e "Master log: ${master_log}"
  echo -e "Detailed log: ${log_file}${NC}\n"
}

_is_cancelled() {
  local log_file="$1"

  # Detect cancellation messages emitted by Terraform across versions
  grep -Eq \
    "Apply cancelled|Apply discarded|Operation cancelled|Cancelled by user|user cancelled|User cancelled|interrupted by user|KeyboardInterrupt|user aborted|Destroy cancelled" \
    "$log_file"
}

_run_terraform() {
  local type="$1"
  shift
  local -a cmd=("$@")

  local use_log=false log_file
  if [[ "$type" == "plan" || "$type" == "apply" || "$type" == "destroy" ]]; then
    use_log=true
    log_file=$(_make_run_log_path "$type") || return 1
  fi

  echo -e "${BLUE}${ROCKET} Running terraform ${type}...${NC}"

  if $use_log; then
      # Run terraform and capture REAL exit code
      "${cmd[@]}" 2>&1 | tee >( _strip_ansi > "$log_file")
      local terraform_rc=${PIPESTATUS[0]}

      if (( terraform_rc == 0 )); then
          _append_master_log "$type" "SUCCESS" "$log_file"
      else
        local status="FAILED"
        local color="$RED"
        local emoji_msg="$CROSSMARK"

        # Unified cancellation detection for plan/apply/destroy
        if _is_cancelled "$log_file"; then
            status="CANCELLED"
            color="$YELLOW"
            emoji_msg="$CANCEL"
        fi

        _append_master_log "$type" "$status" "$log_file"
        echo -e "${color}${emoji_msg} ${type} ${status,,}! See log above.${NC}"
      fi
  else
      # No logging mode (init, validate, fmt)
      "${cmd[@]}"
      local terraform_rc=$?

      if (( terraform_rc == 0 )); then
          echo -e "${GREEN}${CHECKMARK} Terraform ${type} finished successfully!${NC}"
      else
          echo -e "${RED}${CROSSMARK} Terraform ${type} failed!${NC}"
      fi
  fi
}

tf_init() {
  local -a cmd=("terraform" "init")
  [[ -f "backend.hcl" ]] && cmd+=("--backend-config=backend.hcl")
  _run_terraform "init" "${cmd[@]}"
}

tf_validate() {
  _run_terraform "validate" terraform validate
}

tf_plan() {
  wsl_alert _run_terraform "plan" terraform plan
}

tf_apply() {
  wsl_alert _run_terraform "apply" terraform apply
}

tf_apply_auto() {
  wsl_alert _run_terraform "apply" terraform apply -auto-approve
}

tf_destroy() {
  echo -e "${RED}${CANCEL} WARNING: This will destroy resources!${NC}"
  local CONFIRM
  read -p "Type 'yes' to continue: " CONFIRM
  
  if [[ "$CONFIRM" != "yes" ]]; then
    local log_file
    log_file=$(_make_run_log_path "destroy") || return 1
    _append_master_log "destroy" "CANCELLED" "$log_file"
    echo -e "${YELLOW}Operation cancelled.${NC}"
    return 0
  fi
  
  wsl_alert _run_terraform "destroy" terraform destroy
}

tf_destroy_auto() {
  wsl_alert _run_terraform "destroy" terraform destroy -auto-approve
}

tf_fmt() {
  _run_terraform "fmt" terraform fmt -recursive
}

alias tf="terraform"
alias tfi='tf_init'
alias tfv='tf_validate'
alias tfp='tf_plan'
alias tfa='tf_apply'
alias tfaa='tf_apply_auto'
alias tfd='tf_destroy'
alias tfda='tf_destroy_auto'
alias tfip='tf_init && tf_plan'
alias tff='tf_fmt'

tf_logs() {
  local show_full=false

  # Parse optional flag
  while (( $# > 0 )); do
    case $1 in
      -f|--full)
        show_full=true
        shift
        ;;
      *)
        shift
        ;;
    esac
  done

  local master
  master=$(_get_master_log) || return 1
  echo -e "${BLUE}Master log: $master${NC}"

  if [[ ! -f "$master" ]]; then
    echo "No logs yet."
    return 0
  fi

  if $show_full; then
    cat "$master"
  else
    head -n 3 "$master"
    echo -e "\nTo see full logs, run: tf_logs -f"
  fi
}

tf_tail() {
  local ws latest
  ws=$(_get_workspace_name) || return 1
  latest=$(find "$TF_LOG_ROOT/$ws" -type f -name "*.log" 2>/dev/null | sort | tail -n 1)
  if [[ -n "$latest" ]]; then
    tail -f "$latest"
  else
    echo "No detailed logs found."
    return 1
  fi
}

# Open current Terraform workspace in browser or print local message
tfo() {
  local ws
  ws=$(_get_workspace_name)
  # Try to find a remote workspace URL in the latest log
  local master_log latest_url
  master_log=$(_get_master_log)
  if [[ -f "$master_log" ]]; then
    # Look for the most recent non-local URL containing .com/app and (terraform or tf)
    latest_url=$(grep -Eo 'https?://[^ ]+' "$master_log" | grep -Ei '\.com/app' | grep -Ei 'terraform|tf' | head -n 1)
    latest_url=$(_strip_ansi_str "$latest_url")
    # Strip /runs/* for workspace url
    latest_url=$(echo "$latest_url" | sed -E 's|/runs/[^/?#]*.*||')
  fi
  if [[ -n "$latest_url" ]]; then
    echo "Opening remote Terraform workspace: $latest_url"
    if command -v xdg-open &>/dev/null; then
      xdg-open "$latest_url" &>/dev/null
    elif command -v powershell.exe &> /dev/null; then
      powershell.exe start "$latest_url"
    elif command -v open &>/dev/null; then
      open "$latest_url"
    elif command -v start &>/dev/null; then
      start "" "$latest_url"
    else
      echo "Could not detect a command to open a browser" >&2
      return 1
    fi
  else
    echo "This workspace appears to be local (no remote URL found for workspace '$ws')."
  fi
}

